{% extends "base.html" %}

{% block title %}Select Photos - photos.local{% endblock %}

{% block content %}
<div class="setup-wizard">
    <div class="step-indicator">
        <span class="step complete">1. WiFi</span>
        <span class="step complete">2. Google</span>
        <span class="step active">3. Photos</span>
    </div>

    <h2>Select Photos</h2>
    <p>Choose which photos from Google Photos to display on your frame.</p>

    {% if cache_stats.count > 0 %}
    <div class="info-box">
        <p><strong>{{ cache_stats.count }}</strong> photos already cached ({{ cache_stats.size_mb }} MB)</p>
    </div>
    {% endif %}

    <div id="picker-status" class="status-box" style="display: none;">
        <div class="spinner"></div>
        <p id="picker-message">Opening Google Photos picker...</p>
    </div>

    <div id="picker-actions" class="form-actions">
        <button type="button" class="btn btn-primary btn-large" onclick="startPicker()">
            Select Photos from Google Photos
        </button>

        {% if cache_stats.count > 0 %}
        <form method="POST" action="{{ url_for('index') }}" style="display: inline;">
            <button type="submit" class="btn btn-secondary">
                Skip - Use Existing Photos
            </button>
        </form>
        {% endif %}
    </div>

    <div id="sync-actions" class="form-actions" style="display: none;">
        <form method="POST" action="{{ url_for('setup_album') }}" id="sync-form">
            <input type="hidden" name="action" value="sync_photos">
            <input type="hidden" name="session_id" id="session-id">
            <button type="submit" class="btn btn-primary btn-large">
                Download Selected Photos
            </button>
        </form>
    </div>

    <div class="help-text">
        <h3>How it works:</h3>
        <ol>
            <li>Click "Select Photos" to open Google's photo picker</li>
            <li>Choose individual photos or entire albums</li>
            <li>Close the picker when done</li>
            <li>Photos will be downloaded to your frame</li>
        </ol>
    </div>
</div>

<script>
let pickerWindow = null;
let sessionId = null;
let pollInterval = null;

function startPicker() {
    const statusBox = document.getElementById('picker-status');
    const actionsBox = document.getElementById('picker-actions');
    const messageEl = document.getElementById('picker-message');

    statusBox.style.display = 'block';
    actionsBox.style.display = 'none';
    messageEl.textContent = 'Creating picker session...';

    // Create picker session
    fetch('{{ url_for("setup_album") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'action=create_session'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sessionId = data.sessionId;
            document.getElementById('session-id').value = sessionId;

            messageEl.textContent = 'Opening Google Photos picker...';

            // Open picker in new window
            pickerWindow = window.open(data.pickerUri, 'picker', 'width=800,height=600');

            // Start polling for completion
            startPolling();
        } else {
            messageEl.textContent = 'Error: ' + data.error;
            actionsBox.style.display = 'block';
        }
    })
    .catch(error => {
        messageEl.textContent = 'Error: ' + error;
        actionsBox.style.display = 'block';
    });
}

function startPolling() {
    const messageEl = document.getElementById('picker-message');

    pollInterval = setInterval(() => {
        // Check if picker window was closed
        if (pickerWindow && pickerWindow.closed) {
            messageEl.textContent = 'Checking for selected photos...';
        }

        // Poll session status
        fetch('{{ url_for("setup_album") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'action=check_session&session_id=' + sessionId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.complete) {
                clearInterval(pollInterval);
                messageEl.textContent = 'Photos selected! Ready to download.';
                document.getElementById('picker-status').querySelector('.spinner').style.display = 'none';
                document.getElementById('sync-actions').style.display = 'block';
            }
        });
    }, 3000);
}
</script>
{% endblock %}
