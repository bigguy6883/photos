{% extends "base.html" %}
{% block title %}Settings - photos.local{% endblock %}

{% block content %}
<!-- Status -->
<div class="settings-card">
    <h2>Status</h2>
    <div class="status-grid">
        <div class="status-item">
            <span class="label">Photos</span>
            <span class="value">{{ status.photo_count }}</span>
        </div>
        <div class="status-item">
            <span class="label">Slideshow</span>
            <span class="value {% if status.running %}on{% else %}off{% endif %}">
                {{ "Running" if status.running else "Stopped" }}
            </span>
        </div>
        <div class="status-item">
            <span class="label">Interval</span>
            <span class="value">{{ status.interval_minutes }}m</span>
        </div>
        <div class="status-item">
            <span class="label">Order</span>
            <span class="value">{{ status.order|capitalize }}</span>
        </div>
    </div>
</div>

<!-- Display Settings -->
<div class="settings-card">
    <h2>Display</h2>

    <div class="setting-row">
        <div class="setting-label">
            Fit Mode
            <small>How photos fit the screen</small>
        </div>
        <select id="fitMode" onchange="saveSetting('display', 'fit_mode', this.value)">
            <option value="contain" {% if settings.display.fit_mode == 'contain' %}selected{% endif %}>Contain (black bars)</option>
            <option value="cover" {% if settings.display.fit_mode == 'cover' %}selected{% endif %}>Cover (crop edges)</option>
            <option value="stretch" {% if settings.display.fit_mode == 'stretch' %}selected{% endif %}>Stretch</option>
        </select>
    </div>

    <div class="setting-row">
        <div class="setting-label">
            Smart Recenter
            <small>Use face/subject detection for cover crop</small>
        </div>
        <label class="toggle-switch">
            <input type="checkbox" id="smartRecenter"
                   {% if settings.display.smart_recenter %}checked{% endif %}
                   onchange="saveSetting('display', 'smart_recenter', this.checked)">
            <span class="toggle-slider"></span>
        </label>
    </div>

    <div class="setting-row">
        <div class="setting-label">
            Saturation
            <small>E-ink color vibrancy</small>
        </div>
        <input type="range" id="saturation" min="0" max="1" step="0.1"
               value="{{ settings.display.saturation }}"
               onchange="saveSetting('display', 'saturation', this.value); document.getElementById('satVal').textContent = this.value">
        <span class="range-value" id="satVal">{{ settings.display.saturation }}</span>
    </div>

    <div class="setting-row">
        <div class="setting-label">
            Orientation
        </div>
        <select id="orientation" onchange="saveSetting('display', 'orientation', this.value)">
            <option value="horizontal" {% if settings.display.orientation == 'horizontal' %}selected{% endif %}>Horizontal</option>
            <option value="vertical" {% if settings.display.orientation == 'vertical' %}selected{% endif %}>Vertical</option>
        </select>
    </div>
</div>

<!-- Slideshow Settings -->
<div class="settings-card">
    <h2>Slideshow</h2>

    <div class="setting-row">
        <div class="setting-label">Interval</div>
        <select id="interval" onchange="saveSetting('slideshow', 'interval_minutes', parseInt(this.value))">
            {% for opt in interval_options %}
            <option value="{{ opt }}" {% if settings.slideshow.interval_minutes == opt %}selected{% endif %}>
                {% if opt < 60 %}{{ opt }} minutes{% elif opt == 60 %}1 hour{% elif opt < 1440 %}{{ opt // 60 }} hours{% else %}24 hours{% endif %}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="setting-row">
        <div class="setting-label">Order</div>
        <select id="order" onchange="saveSetting('slideshow', 'order', this.value)">
            <option value="random" {% if settings.slideshow.order == 'random' %}selected{% endif %}>Random</option>
            <option value="sequential" {% if settings.slideshow.order == 'sequential' %}selected{% endif %}>Sequential</option>
        </select>
    </div>

    <div class="setting-row">
        <div class="setting-label">Controls</div>
        <div>
            {% if status.running %}
            <button class="btn btn-danger btn-sm" onclick="slideshowAction('stop')">Stop Slideshow</button>
            {% else %}
            <button class="btn btn-success btn-sm" onclick="slideshowAction('start')">Start Slideshow</button>
            {% endif %}
        </div>
    </div>
</div>

<!-- WiFi -->
<div class="settings-card">
    <h2>WiFi</h2>
    <div class="setting-row">
        <div class="setting-label">Network</div>
        <div>
            <span>{{ settings.wifi.ssid or "Not configured" }}</span>
            <a href="/setup/wifi" class="btn btn-sm btn-secondary" style="margin-left:8px">Change</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function saveSetting(section, key, value) {
    const data = {};
    data[section] = {};
    data[section][key] = value;

    fetch('/api/settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
}

function slideshowAction(action) {
    fetch('/api/slideshow/' + action, {method: 'POST'})
        .then(() => location.reload());
}
</script>
{% endblock %}
